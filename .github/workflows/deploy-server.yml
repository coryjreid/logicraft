name: Deploy Minecraft Server

on: 
  workflow_dispatch:
  release:
    types: [published]

env:
  MINECRAFT_DOCKER_CONTAINER_NAME: ${{ secrets.GAME_SERVER_DOCKER_CONTAINER_NAME }}
  MINECRAFT_COMPOSE_DIRECTORY: ${{ secrets.GAME_SERVER_COMPOSE_DIRECTORY }}
  DEPLOYMENT_SCRIPT_NAME: redeploy-game-server.sh

jobs:
  validate-pack-before-deploy:
    uses: ./.github/workflows/packwiz-pack-test.yml
  deploy-web-server:
    uses: ./.github/workflows/deploy-web-server.yml
    secrets: inherit
    needs: validate-pack-before-deploy
  deploy-server:
    runs-on: ubuntu-latest
    needs: [validate-pack-before-deploy, deploy-web-server]
    steps:
      # Setup
      - name: "Set dynamic environment variables"
        run: |
          echo "DEPLOYMENT_SCRIPT_PATH=/tmp/$DEPLOYMENT_SCRIPT_NAME" >> $GITHUB_ENV
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.GAME_SERVER_SSH_KEY }}
          known_hosts: "just-a-placeholder-so-we-dont-get-errors"
      - name: Adding Known Hosts
        run: ssh-keyscan -H ${{ secrets.GAME_SERVER_IP }} >> ~/.ssh/known_hosts
      - name: Copy deploy script to game server
        run: scp ./build/$DEPLOYMENT_SCRIPT_NAME ${{ secrets.SSH_USERNAME }}@${{ secrets.GAME_SERVER_IP }}:$DEPLOYMENT_SCRIPT_PATH
      - name: Make deploy script executable
        run: ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.GAME_SERVER_IP }} "chmod +x $DEPLOYMENT_SCRIPT_PATH"
      # Deploy
      - name: Run deploy script
        run: ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.GAME_SERVER_IP }} "$DEPLOYMENT_SCRIPT_PATH"
      # Cleanup
      - name: Cleanup
        run: ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.GAME_SERVER_IP }} "rm -f $DEPLOYMENT_SCRIPT_PATH"
