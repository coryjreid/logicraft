name: Deploy Minecraft Server

on: 
  workflow_dispatch:
    inputs:
      skip-tests:
        description: "Skip packwiz tests"
        default: false
        required: true
        type: boolean
      skip-web-server-deploy:
        description: "Skip web server deployment"
        default: false
        required: true
        type: boolean
  release:
    types: [published]

env:
  MINECRAFT_DOCKER_CONTAINER_NAME: ${{ secrets.GAME_SERVER_DOCKER_CONTAINER_NAME }}
  DEPLOYMENT_SCRIPT_NAME: redeploy-game-server.sh

jobs:
  validate-pack-before-deploy:
    if: inputs.skip-tests == false
    uses: ./.github/workflows/packwiz-pack-test.yml
  deploy-web-server:
    if: inputs.skip-web-server-deploy == false
    uses: ./.github/workflows/deploy-web-server.yml
    secrets: inherit
    needs: validate-pack-before-deploy
  deploy-server:
    runs-on: ubuntu-latest
    needs: [validate-pack-before-deploy, deploy-web-server]
    if: always()
    timeout-minutes: 10
    steps:
      # Validate
      - name: Check for faliures
        if: ${{ contains(needs.*.result, 'failure') }}
        run: exit 1
      # Setup
      - name: "Set dynamic environment variables"
        run: echo "DEPLOYMENT_SCRIPT_PATH=/tmp/$DEPLOYMENT_SCRIPT_NAME" >> $GITHUB_ENV
      - name: Checkout Repository
        uses: actions/checkout@v4.0.0
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.GAME_SERVER_SSH_KEY }}
          known_hosts: "just-a-placeholder-so-we-dont-get-errors"
      - name: Adding Known Hosts
        run: ssh-keyscan -H ${{ secrets.GAME_SERVER_IP }} >> ~/.ssh/known_hosts
      - name: Copy deploy script to game server
        run: scp ./build/$DEPLOYMENT_SCRIPT_NAME ${{ secrets.SSH_USERNAME }}@${{ secrets.GAME_SERVER_IP }}:$DEPLOYMENT_SCRIPT_PATH
      - name: Make deploy script executable
        run: ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.GAME_SERVER_IP }} "chmod +x $DEPLOYMENT_SCRIPT_PATH"
      # Deploy
      - name: Run deploy script
        uses: appleboy/ssh-action@master
        env:
          SERVER_ROOT: ${{ secrets.GAME_SERVER_COMPOSE_DIRECTORY }}/server
          SCRIPT_PATH: ${{ env.DEPLOYMENT_SCRIPT_PATH }}
        with:
          host: ${{ secrets.GAME_SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.GAME_SERVER_SSH_KEY }}
          port: 22
          script_stop: true
          envs: SERVER_ROOT,SCRIPT_PATH
          script: cd $SERVER_ROOT && $SCRIPT_PATH
      # Cleanup
      - name: Cleanup
        run: ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.GAME_SERVER_IP }} "rm -f $DEPLOYMENT_SCRIPT_PATH"
