name: Deploy Minecraft server
on: workflow_dispatch
jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.0.0
      - name: Install Java
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin
      - name: Install markdown command
        run: apt get install -y markdown
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Run Packwiz Pack Test
        uses: ./.github/workflows/packwiz-pack-test.yml
  update-version:
    runs-on: ubuntu-latest
    steps:
      - name: Make Packwiz executable
        run: chmod +x ./bin/packwiz
      - name: Make Dasel executable
        run: chmod +x ./bin/dasel
      - name: Set modpack name
        run: ./bin/dasel put -f ./config/bcc-common.toml -r toml -v Logicraft general.modpackName
      - name: Set modpack curseforge project id
        run: ./bin/dasel put -f ./config/bcc-common.toml -r toml -v 323471 general.modpackProjectID
      - name: Set modpack version
        run: ./bin/dasel put -f ./config/bcc-common.toml -r toml -v `date +%Y%m%d%H%M%S` general.modpackVersion
      - name: Refresh Packwiz indices
        run: ./bin/packwiz refresh
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.IONOS_LOGICRAFT_WEB_SSH_KEY }}
          known_hosts: 'just-a-placeholder-so-we-dont-get-errors'
      - name: Adding Known Hosts
        run: ssh-keyscan -H ${{ secrets.IONOS_LOGICRAFT_WEB_ADDRESS }} >> ~/.ssh/known_hosts